---
title: "TCGA_TUMOUR_NORMAL_ANALYSIS"
output: html_document
date: "2024-02-22"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/Dyll/Documents/Education/VU_UVA/Internship/Epigenetics/Janssen_Group-UMCUtrecht/Main_Project")
knitr::kable(mtcars, format = "html") %>%
  as.character() %>%
  htmltools::HTML(width = "100%")
```
Load the libraries
```{r}
library(dplyr)
library(plyr)
library(coin)
library(knitr)
library(rstatix)
library(tidyverse)
library(psych)
``` 
Load other options
```{r}
getOption("max.print")
```

Load the RNA datasets


```{r}
set.seed(123)

NORMAL_SOI <- read.csv("Data/RNA_Data/TCGA_TPM/TCGA_Normal_mRNA_TPM_SOI.csv")
TUMOUR_SOI <- read.csv("Data/RNA_Data/TCGA_TPM/TCGA_mRNA_TPM_SOI.csv")
Meta_data <- read.csv("Data/Other/TCGA_meta/tissueSourceSite.tsv", sep = "\t")

```

Configure function that builds the set of interest metrics
```{r}

calculate_summary <- function(input_dataframe) {
  df_name <- deparse(substitute(input_dataframe))
  
  # Calculate column means
  means <- colMeans(input_dataframe[, -c(1, 2)], na.rm = TRUE)
  
  # Create a new dataframe to store the summary
  Summary_Dataframe <- data.frame( Mean = means)
  
  prefix <- sub("^(.*?)_.*$", "\\1", df_name)

  colnames(Summary_Dataframe)[colnames(Summary_Dataframe) == "Mean"] <- paste0(prefix, "_geom_mean")
  
  return(Summary_Dataframe)
}
```



Build the metrics dfs for both the tumour and the normal data and merge the dfs on the shared Participants
```{r}
SOI_COMBO <- merge(calculate_summary(NORMAL_SOI) %>%
                     rownames_to_column(var = "id") %>%
                     rowwise() %>% 
                     mutate( Participant = strsplit(id,"\\.")[[1]][3]) %>% 
                     select(-c("id")),
                   calculate_summary(TUMOUR_SOI)%>%
                     rownames_to_column(var = "id") %>%
                     rowwise() %>% 
                   mutate( Participant = strsplit(id,"\\.")[[1]][3]) %>% 
                     select(-c("id")),
                 by = "Participant",
                 all = FALSE)
kable(head(SOI_COMBO, n = 15))
```


construct a table to perform a paired wilcoxon test to assess the differences between the two conditions using the aggregate values of the SOI
```{r}

data <- SOI_COMBO %>% 
  gather(key = "Condition", value = "Geom_mean", NORMAL_geom_mean, TUMOUR_geom_mean)
kable(head(data, n = 15))
```


Plotting the distribution of the difference between the means to assess the symmetry and whether a wilcoxon signed rank test can be applied to the data. Also assessing the 'Skew' metric for the same purpose
```{r}
SOI_COMBO$DIF <- SOI_COMBO$TUMOUR_geom_mean - SOI_COMBO$NORMAL_geom_mean
ggplot(SOI_COMBO, aes(x = "", y = SOI_COMBO$DIF)) + 
  stat_boxplot(geom = "errorbar",
               width = 0.15) + 
  geom_boxplot()


describe(SOI_COMBO) %>% kable()
```
Results: Fairly symmetrical boxplot and skew of 0.4131667
Interpretation: Given that the plot is quite symmetrical and that the skew value is between 0 and 1, I can assume that the distribution is approximately symmetric, and can therefore use a Wilcoxon Signed Rank test.




Summary stats
```{r}
data %>%
  group_by(Condition) %>%
  get_summary_stats(Geom_mean, type = "median_iqr") %>% kable()
```



Boxplots to visualise the difference between the set of interest in cancerous data and the non-cancerous data
```{r}
bxp <- ggpaired(data, x = "Condition", y = "Geom_mean", 
         order = c("NORMAL_geom_mean", "TUMOUR_geom_mean"),
         ylab = "Geom_mean", xlab = "Condition")
bxp
```




Perform the wilcoxon signed rank test to detect a significant difference between the set of interest in cancerous data and the non-cancerous data
```{r}
stat.test <- data  %>%
  wilcox_test(Geom_mean ~ Condition, paired = TRUE, alternative = "less") %>%
  add_significance() 
stat.test

observed_val <- stat.test$p
```


Perform the same test but using the genes from the different control sets 

```{r}
start_time <- Sys.time()
results <- list()

# Loop over the control datasets
num_datasets <- 547

for (i in 1:num_datasets) {
 

  can_ctrl_file <- paste("Data/RNA_Data/TCGA_TPM/TCGA_Cancer_CTRL_Sets/TCGA_TPM_RNA_Control_df", i, ".csv", sep = "")
  can_ctrl_set <- read.csv(can_ctrl_file)
  
  nrm_ctrl_file <- paste("Data/RNA_Data/TCGA_TPM/TCGA_Normal_CTRL_Sets/TCGA_Normal_mRNA_TPM_CTRL_Set", i, ".csv", sep = "")
  nrm_ctrl_set <- read.csv(nrm_ctrl_file)
  

  new_combo <- merge(calculate_summary(can_ctrl_set) %>%
                     rownames_to_column(var = "id") %>%
                     rowwise() %>% 
                     mutate( Participant = strsplit(id,"\\.")[[1]][3]) %>% 
                     select(-c("id")),
                   calculate_summary(nrm_ctrl_set)%>%
                     rownames_to_column(var = "id") %>%
                     rowwise() %>% 
                   mutate( Participant = strsplit(id,"\\.")[[1]][3]) %>% 
                     select(-c("id")),
                 by = "Participant",
                 all = FALSE)
  
  new_data <- new_combo %>% 
    gather(key = "Condition", value = "Geom_mean", nrm_geom_mean, can_geom_mean)
  
  new_stat.test <- new_data  %>%
    wilcox_test(Geom_mean ~ Condition, paired = TRUE, alternative = "less") %>%
    add_significance() 
  
  results[[i]] <- new_stat.test
  
  it_time <- Sys.time()
  cat('\n',i,"th iteration duration: ", it_time - start_time, "seconds")
}
```

```{r}
full_results <- do.call(rbind, results) 
full_results <- mutate(full_results, Adjusted_p = p.adjust(full_results$p, method = "BH"), 
                       Significant_value = ifelse(Adjusted_p < 0.05, "TRUE" , "FALSE"),
                       ex_Level = ifelse(Adjusted_p <= observed_val, "TRUE" , "FALSE"),
                       sim_Level = ifelse(p.signif == "****", "TRUE" , "FALSE"))

kable(head(full_results)) 
```



```{r}
Contrast_agg_count_table <- full_results %>% group_by(sim_Level) %>% dplyr::summarise(count = n()) 
Contrast_agg_count_table$Freq <- round(Contrast_agg_count_table$count / sum(Contrast_agg_count_table$count), 3)
kable(Contrast_agg_count_table)

```

